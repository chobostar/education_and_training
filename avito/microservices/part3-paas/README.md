###PaaS, use-cases, имплементация

###Зачем
- изолировать продуктовую разработки от инфраструктуры
    - секреты
    - настройки pgbouncer
    - в целом упрощение конфигурирования сервисов
    - интеграция с инфраструктурой, базами
    - настройки периодических задач
    - уменьшать вероятность ошибок
    - изменения инфраструктуры без участия продуктовых разработчиков

###avito service create
- создает ресурсы
    - stash
    - sentry
    - k8s
    - grafana, TC, swagger

###service
- endpoint /_info
    - healthcheck (HTTP 200)
- push metrics по api ручкам
- сбор runtime метрик
- экспорт логов в mongodb/kibana
- sentry прицеплен к логгеру
- готовый дашборд в grafana
    - mem, cpu utilization
- tracing spans, далее можно смотреть jaeger

###app.toml
- минимальная конфигурация
- kind
    - business - приходится нагрузка от пользователей продукта
    - infrastructure - не работает с данными пользователями продукта
- replicas - горизонтальная масштабируемость
- size - ресурсы, которые будут выделены сервису
- service dependencies - от каких сервисов зависит

###local dev env
- minikube
- PaaS services
- для зависимых сервисов ходит в staging

###avito service dev
###avito service debug
###avito service connect
###avito service push
- деплоит сервис в http://<service-name>-<branch>.k.avito.ru

#avito service deploy -e prod
- build образа
- run tests
- deploy to k8s
###avito service deploy
###avito service canary
###avito service bluegreen 



###Особенности реализации
- идея платформы закрыть все что происходит внутри
    - облако - динамичная среда
- instance сервиса может быть убит в любой момент
    - redundancy (replicas)
- равномерное распределение ресурсов не гарантируется
    - каждый инстант будет иметь разное количество ресурсов
    - разные latency
- деградация части не должна приводить к полному отказу

###Идентификация сервисов
- X-Source http header
- Автоматическое добавление на уровне сети
- https://paas/interaction/xsource/

###Интеграция с базами
- avito {postgresql, redis, mongodb, rabbitmq} add
    - Добавленную БД в app.toml
    - Добавленные зависимости для работы с базой из сервиса, в случае наличия поддержки

###Взаимодействие с базами
- Autodiscovery
- Подключение без указания endpoint
- Автоматическая интеграция с секретами
- Прокси без лишнего хопа по сети

###Взаимодействие сервисов
- Походы в сервисы
    - avito codegen автогенерируемые клиенты
        - таймауты
        - паттерн circuit breaker
        - retries
    - avito service dependency add
    - brief https://paas/howto/brief_client/
        - Формат декларативного описания структур данных, RPC интерфейсов, data bus событий.

###Интеграция с шиной данных
- реест схем
- валидация схем

###Обратная совместимость
- Версионирование API
    - rpc search -> rpc searchV2
- backward в кэше
    - необходимо поддерживать оба вида кэша в переходный период

###Tracing
- legacy сервиса делают сбор span, но для них не работает tracing
- просмотр зависимостей
- просмотр собранных span
- debug запрос

###avito service logs
- json
- disconnect 20 minutes	

###Sentry
- идея его использование, должна быть - отложенный алерт
- ошибки, исключительных ситуаций.

###paas dashboard
- стата, управление
- лента релизов сервисов
- юнит -> сервисы -> потенциальные проблемы
    - например, много 500-х
    - oom killer
    - ...

###summary
- эксплуатация и сопровождение делается силами разработчика
    - alert.yaml
- планировать запуск, feature toggle
- chaos тестирование, учитывать отказы зависимостей
- если есть кэш, подумать про холодный старт
- метрики
- документация особенностей
- нагрузочное тестирование, NFR, количество реплик

###Проектирование
- Начинайте проектирование с представления системы “сверху”
- Избегайте append-only решений, добавляйте логику в существующие сервисы
- Ваш интерфейс – это commitment надолго
- Взвешивайте плюсы/минусы вынесения кода в библиотеку/микросервис
- Избегайте жесткой связанности
- Поддерживайте независимость разработки и выкатки

###Интерфейсы
- Не ломайте
- Делайте их простыми для понимания (по конкретным задачам пользователей)
- Явно описывайте интерфейс, добавляя в описание максимум необходимой документации

###Работа с данными
- Не пишите бизнес логику на стороне базы
- Не используйте одно хранилище для разных сервисов
- Не складывайте в шину полные объекты без необходимости
- Кэшируйте данные там, где это возможно
- Не храните данные в подах, используйте persistent хранилища

###Взаимодействие сервисов
- Со стороны клиентов четко декларируйте только то, что вам необходимо из другого сервиса
- При возможности, используйте асинхронное взаимодействие
- Поддерживайте graceful degradation везде
- Используйте паттерн tolerant reader
- Покрывайте все метриками

###Тестирование
- Избегайте e2e тестирования
- Пишите Unit тесты на бизнес логику
- Используйте Canary релизы

###Эксплуатация
- Вы ответственны за работу сервиса
- Определяйте NFR для ваших endpoint
- Используйте Grafana для просмотра состояния
- Настраивайте алерты через alert.yaml
- Используйте Sentry для просмотра необработанных ошибок
- Используйте distributed tracing для поиска узла с проблемой







